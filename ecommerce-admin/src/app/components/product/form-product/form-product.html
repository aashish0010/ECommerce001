<form class="theme-form theme-form-2 mega-form" [formGroup]="form" (ngSubmit)="submit(true)">
  <div class="vertical-tabs">
    <div class="row">
      <div class="col-xl-3 col-lg-4">
        <ul ngbNav #nav="ngbNav" [(activeId)]="active" class="nav-pills" orientation="vertical">

          <!-- General Tab -->
          <li ngbNavItem="general" id="general" [class.is-invalid]="tabError.includes('general')">
            <a ngbNavLink><i class="ri-settings-line"></i>{{ 'general' | translate }}</a>
            <ng-template ngbNavContent>
              <div class="tab" tab="general">
                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'name'"
                  [for]="'name'"
                  [required]="true"
                >
                  <input class="form-control" id="name" type="text"
                    placeholder="{{ 'enter_product_name' | translate }}" formControlName="name" />
                  @if(form.controls['name'].touched && form.controls['name'].errors?.['required']){
                  <div class="invalid-feedback">{{ 'name_is_required' | translate }}</div>
                  }
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'short_description'"
                  [for]="'short_description'"
                  [required]="true"
                >
                  <textarea class="form-control" id="short_description"
                    placeholder="{{ 'enter_short_description' | translate }}" rows="3"
                    formControlName="short_description"></textarea>
                  <p class="help-text">{{ '*Maximum length should be 300 characters.' }}</p>
                  @if(form.controls['short_description'].touched && form.controls['short_description'].errors?.['required']){
                  <div class="invalid-feedback">{{ 'short_description_is_required' | translate }}</div>
                  }
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'description'"
                  [for]="'description'"
                  [required]="true"
                >
                  <div class="custom-editor editor-checkbox">
                    <div class="form-check form-switch">
                      <input class="form-check-input" id="ckcheck" type="checkbox"
                        name="isCodeEditor" [(ngModel)]="isCodeEditor"
                        [ngModelOptions]="{standalone: true}" />
                      <label for="ckcheck" class="cursor-pointer">
                        <span class="edit"><i class="ri-edit-box-line"></i></span>
                        <span class="code"><i class="ri-code-s-slash-line"></i></span>
                      </label>
                    </div>
                    @if(isBrowser) {
                    <div [class]="!isCodeEditor ? 'd-none' : 'd-block'">
                      <ngx-editor-menu [editor]="editor" />
                      <ngx-editor [editor]="editor" [placeholder]="'Type here...'"
                        formControlName="description" [(ngModel)]="html"
                        (ngModelChange)="getData($event)" />
                    </div>
                    }
                    <div class="editor-textarea" [class]="isCodeEditor ? 'd-none' : 'd-block'">
                      <textarea class="form-control"
                        placeholder="{{ 'enter_html_content' | translate }}" rows="3"
                        [formControl]="textArea" (keyup)="getText($event)"></textarea>
                      <p class="mt-2">*{{ "only_accept_html_tags" | translate }}</p>
                    </div>
                    @if(form.controls['description'].touched && form.controls['description'].errors?.['required']){
                    <div class="invalid-feedback">{{ 'description_is_required' | translate }}</div>
                    }
                  </div>
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'price'"
                  [for]="'price'"
                  [required]="true"
                >
                  <input class="form-control" id="price" type="number"
                    placeholder="Enter price" formControlName="price" />
                  @if(form.controls['price'].touched && form.controls['price'].errors?.['required']){
                  <div class="invalid-feedback">Price is required</div>
                  }
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'sale_price'"
                  [for]="'sale_price'"
                  [required]="false"
                >
                  <input class="form-control" id="sale_price" type="number"
                    placeholder="Enter sale price" formControlName="sale_price" />
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'sku'"
                  [for]="'sku'"
                  [required]="true"
                >
                  <input class="form-control" id="sku" type="text"
                    placeholder="Enter SKU" formControlName="sku" />
                  @if(form.controls['sku'].touched && form.controls['sku'].errors?.['required']){
                  <div class="invalid-feedback">SKU is required</div>
                  }
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'quantity'"
                  [for]="'quantity'"
                  [required]="true"
                >
                  <input class="form-control" id="quantity" type="number"
                    placeholder="Enter quantity" formControlName="quantity" />
                  @if(form.controls['quantity'].touched && form.controls['quantity'].errors?.['required']){
                  <div class="invalid-feedback">Quantity is required</div>
                  }
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'stock_status'"
                  [for]="'stock_status'"
                  [required]="false"
                >
                  @if(isBrowser) {
                  <select2 class="custom-select"
                    [placeholder]="'select_stock_status' | translate"
                    [data]="stocks" formControlName="stock_status" id="stock_status" />
                  }
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'categories'"
                  [for]="'categories'"
                  [required]="true"
                >
                  <app-advance-dropdown
                    [options]="(category$ | async)?.data"
                    [selectedOption]="selectedCategories"
                    [subArrayKey]="'subcategories'"
                    (selectedItem)="selectCategoryItem($event)"
                  />
                  @if(form.controls['categories'].touched && form.controls['categories'].errors?.['required']){
                  <div class="invalid-feedback">Category is required</div>
                  }
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'brand'"
                  [for]="'brand_id'"
                  [required]="false"
                >
                  @if(isBrowser) {
                  <select2 class="custom-select"
                    [placeholder]="'select_brand' | translate"
                    [data]="(brand$ | async)?.length ? (brand$ | async) : []"
                    formControlName="brand_id" id="brand_id"
                    noResultMessage="{{ 'no_data_found' | translate }}" resettable />
                  }
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'is_featured'"
                  [for]="'is_featured'"
                  [required]="false"
                >
                  <div class="form-check form-switch ps-0">
                    <label class="switch">
                      <input type="checkbox" id="is_featured" formControlName="is_featured" />
                      <span class="switch-state"></span>
                    </label>
                  </div>
                </app-form-fields>

                <app-form-fields
                  [labelClass]="'form-label-title col-sm-3 mb-0'"
                  [gridClass]="'col-sm-9'"
                  [label]="'status'"
                  [for]="'status'"
                  [required]="false"
                >
                  <div class="form-check form-switch ps-0">
                    <label class="switch">
                      <input type="checkbox" id="status" formControlName="status" />
                      <span class="switch-state"></span>
                    </label>
                  </div>
                </app-form-fields>
              </div>
            </ng-template>
          </li>

          <!-- Images Tab -->
          <li ngbNavItem="images" id="images" [class.is-invalid]="tabError.includes('images')">
            <a ngbNavLink><i class="ri-image-line"></i>{{ 'product_images' | translate }}</a>
            <ng-template ngbNavContent>
              <div class="tab" tab="images">
                <div class="mb-4">
                  <h6 class="fw-semibold">Product Images</h6>
                  <p class="text-muted small">
                    Select images from your system. They will be uploaded automatically.
                    The first image is used as the thumbnail. Max 5MB per image (JPEG, PNG, GIF, WebP).
                  </p>
                </div>

                <!-- File picker -->
                <div class="mb-4">
                  <label class="btn btn-outline-primary" for="imageFileInput">
                    <i class="ri-upload-cloud-2-line me-1"></i> Choose Images
                  </label>
                  <input type="file" id="imageFileInput" class="d-none" multiple
                    accept="image/jpeg,image/png,image/gif,image/webp"
                    (change)="onFilesSelected($event)" />
                  @if(isUploading) {
                  <span class="ms-2 text-muted small">
                    <i class="ri-loader-4-line spin"></i> Uploading...
                  </span>
                  }
                </div>

                <!-- Image grid -->
                @if(images.length) {
                <div class="row g-3">
                  @for(image of images; track $index; let i = $index) {
                  <div class="col-6 col-sm-4 col-md-3">
                    <div class="position-relative border rounded overflow-hidden"
                      style="aspect-ratio: 1;" [ngClass]="{'opacity-50': image.uploading}">
                      <img [src]="image.preview || image.url" class="w-100 h-100"
                        style="object-fit: cover;" />
                      @if(image.uploading) {
                      <div class="position-absolute top-50 start-50 translate-middle">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                      </div>
                      }
                      @if(!image.uploading) {
                      <button type="button"
                        class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 rounded-circle p-0"
                        style="width: 24px; height: 24px; line-height: 24px;"
                        (click)="removeImage(i)">
                        <i class="ri-close-line" style="font-size: 14px;"></i>
                      </button>
                      }
                      @if(i === 0 && !image.uploading) {
                      <span class="badge bg-primary position-absolute bottom-0 start-0 m-1">Thumbnail</span>
                      }
                    </div>
                  </div>
                  }
                </div>
                } @else {
                <div class="text-center py-5 border rounded bg-light">
                  <i class="ri-image-add-line" style="font-size: 48px; color: #ccc;"></i>
                  <p class="text-muted mt-2 mb-0">No images added yet. Click "Choose Images" to upload.</p>
                </div>
                }
              </div>
            </ng-template>
          </li>

        </ul>
      </div>
      <div class="col-xl-7 col-lg-8">
        <div [ngbNavOutlet]="nav"></div>
      </div>
    </div>
    <div class="ms-auto justify-content-end d-flex gap mt-sm-4 mt-2">
      @if(type() === 'edit'){
      <app-button
        [id]="'product_save_btn'"
        [class]="'btn btn-theme ms-auto mt-4 me-2'"
        [type]="'button'"
        (click)="submit(false)"
      >
        {{ 'save_and_continue' | translate }}
      </app-button>
      }
      <app-button [id]="'product_btn'">{{ 'save' | translate }}</app-button>
    </div>
  </div>
</form>
