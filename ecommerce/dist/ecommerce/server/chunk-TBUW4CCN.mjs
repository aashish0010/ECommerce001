import './polyfills.server.mjs';
import{a as A,b as S,c as O,d as C,e as g,f as T,g as v,h,i as w,j}from"./chunk-JNOS75IN.mjs";import{i as x}from"./chunk-ZSAWBTYV.mjs";import{k as N,m as d,n as I,o as _}from"./chunk-KL6F6H7P.mjs";import{ca as k,ha as q,i as s,k as b}from"./chunk-KHPBT355.mjs";import{a as y,b as m}from"./chunk-S6KH3LOX.mjs";var l=class f{constructor(){this.notificationService=q(x),this.store=q(N)}ngxsOnInit(o){o.dispatch(new w(!1)),o.dispatch(new h)}static cartItems(o){return o.items}static cartTotal(o){return o.total}static cartHasDigital(o){return o.is_digital_only}static stickyCart(o){return o.stickyCartOpen}static sidebarCartOpen(o){return o.sidebarCartOpen}getCartItems(o){}add(o,i){return i.payload.id?this.store.dispatch(new C(i.payload)):this.store.dispatch(new S(i.payload))}addToLocalStorage(o,i){let u=i.payload.variation?i.payload.variation.sale_price:i.payload.product?.sale_price,t={is_digital_only:!1,items:[{id:Number(Math.floor(Math.random()*1e4).toString().padStart(4,"0")),quantity:i.payload.quantity,sub_total:u?u*i.payload.quantity:0,product:i.payload.product,product_id:i.payload.product_id,wholesale_price:null,variation:i.payload.variation,variation_id:i.payload.variation_id}]},a=o.getState(),n=[...a.items],c=n.findIndex(e=>e.id===t.items[0].id),r=y({},a);c==-1&&(a.items.length?t.items[0].variation?a.items.find(e=>e.variation_id==t.items[0].variation_id)?n.find(e=>{if(e.variation_id&&e.variation_id==t.items[0].variation_id){let p=e?.variation?.quantity;if(p<e?.quantity+i?.payload.quantity)return this.notificationService.showError(`You can not add more items than available. In stock ${p} items.`),!1;e.quantity=e?.quantity+t.items[0].quantity,e.sub_total=e?.quantity*e?.variation?.sale_price}}):r.items=[...a.items,...t.items]:a.items.find(e=>e.product_id==t.items[0].product_id)?n.find(e=>{if(e.product_id==t.items[0].product_id){let p=e?.product?.quantity;if(p<e?.quantity+i?.payload.quantity)return this.notificationService.showError(`You can not add more items than available. In stock ${p} items.`),!1;e.quantity=e?.quantity+t.items[0].quantity,e.sub_total=e?.quantity*e.product.sale_price}}):r.items=[...a.items,...t.items]:r.items=[...a.items,...t.items]),r.items.filter(e=>{e?.variation&&(e.variation.selected_variation=e?.variation?.attribute_values?.map(p=>p.value)?.join("/"))}),r.total=r.items.reduce((e,p)=>e+Number(p.sub_total),0),r.stickyCartOpen=!0,r.sidebarCartOpen=!0,r.is_digital_only=r.items.map(e=>e.product&&e?.product?.product_type).every(e=>e=="digital"),o.patchState(r),setTimeout(()=>{this.store.dispatch(new h)},1500)}update(o,i){let u=o.getState(),t=[...u.items],a=t.findIndex(r=>Number(r.id)===Number(i.payload.id));if(t[a]?.variation&&i.payload.variation_id&&Number(t[a].id)===Number(i.payload.id)&&Number(t[a]?.variation_id)!=Number(i.payload.variation_id))return this.store.dispatch(new g(i.payload));let n=t[a]?.variation?t[a]?.variation?.quantity:t[a]?.product?.quantity;if(n<t[a]?.quantity+i?.payload.quantity)return this.notificationService.showError(`You can not add more items than available. In stock ${n} items.`),!1;if(t[a]?.variation&&(t[a].variation.selected_variation=t[a]?.variation?.attribute_values?.map(r=>r.value)?.join("/")),t[a].quantity=t[a]?.quantity+i?.payload.quantity,t[a].sub_total=t[a]?.quantity*(t[a]?.variation?t[a]?.variation?.sale_price:t[a].product.sale_price),t[a].product?.wholesales?.length){let r=t[a].product.wholesales.find(e=>e.min_qty<=t[a].quantity&&e.max_qty>=t[a].quantity)||null;r&&t[a].product.wholesale_price_type=="fixed"?(t[a].sub_total=t[a].quantity*r.value,t[a].wholesale_price=t[a].sub_total/t[a].quantity):r&&t[a].product.wholesale_price_type=="percentage"?(t[a].sub_total=t[a].quantity*(t[a]?.variation?t[a]?.variation?.sale_price:t[a].product.sale_price),t[a].sub_total=t[a].sub_total-t[a].sub_total*(r.value/100),t[a].wholesale_price=t[a].sub_total/t[a].quantity):(t[a].sub_total=t[a]?.quantity*(t[a]?.variation?t[a]?.variation?.sale_price:t[a].product.sale_price),t[a].wholesale_price=null)}else t[a].sub_total=t[a]?.quantity*(t[a]?.variation?t[a]?.variation?.sale_price:t[a].product.sale_price),t[a].wholesale_price=null;if(t[a].quantity<1)return this.store.dispatch(new v(i.payload.id)),b();let c=u.items.reduce((r,e)=>r+Number(e.sub_total),0);o.patchState(m(y({},u),{is_digital_only:t.map(r=>r.product&&r?.product?.product_type).every(r=>r=="digital"),total:c})),this.store.selectSnapshot(r=>r.auth&&r.auth.access_token)}replace(o,i){let u=o.getState(),t=[...u.items],a=t.findIndex(r=>Number(r.id)===Number(i.payload.id));t[a]?.variation&&i.payload.variation_id&&Number(t[a].id)===Number(i.payload.id)&&Number(t[a]?.variation_id)!=Number(i.payload.variation_id)&&(t[a].variation=i.payload.variation,t[a].variation_id=i.payload.variation_id,t[a].variation.selected_variation=t[a]?.variation?.attribute_values?.map(r=>r.value)?.join("/")),t[a].quantity=0;let n=t[a]?.variation?t[a]?.variation?.quantity:t[a]?.product?.quantity;if(n<t[a]?.quantity+i?.payload.quantity)return this.notificationService.showError(`You can not add more items than available. In stock ${n} items.`),!1;if(t[a].quantity=t[a]?.quantity+i?.payload.quantity,t[a].sub_total=t[a]?.quantity*(t[a]?.variation?t[a]?.variation?.sale_price:t[a].product.sale_price),t[a].quantity<1)return this.store.dispatch(new v(i.payload.id)),b();let c=u.items.reduce((r,e)=>r+Number(e.sub_total),0);o.patchState(m(y({},u),{total:c})),this.store.selectSnapshot(r=>r.auth&&r.auth.access_token)}delete(o,{id:i}){let u=o.getState(),t=u.items.filter(n=>n.id!==i),a=t.reduce((n,c)=>n+Number(c.sub_total),0);o.patchState({items:t,is_digital_only:u.items.map(n=>n.product&&n?.product?.product_type).every(n=>n=="digital"),total:a}),this.store.selectSnapshot(n=>n.auth&&n.auth.access_token)}syncCart(o,i){}closeStickyCart(o){let i=o.getState();o.patchState(m(y({},i),{stickyCartOpen:!1}))}toggleSidebarCart(o,{value:i}){let u=o.getState();o.patchState(m(y({},u),{sidebarCartOpen:i}))}clearCart(o){return this.store.selectSnapshot(i=>i.auth&&i.auth.access_token)?o.patchState({items:[],total:0}):o.patchState({items:[],total:0})}static{this.\u0275fac=function(i){return new(i||f)}}static{this.\u0275prov=k({token:f,factory:f.\u0275fac})}};s([d(A)],l.prototype,"getCartItems",null);s([d(O)],l.prototype,"add",null);s([d(S)],l.prototype,"addToLocalStorage",null);s([d(C)],l.prototype,"update",null);s([d(g)],l.prototype,"replace",null);s([d(v)],l.prototype,"delete",null);s([d(T)],l.prototype,"syncCart",null);s([d(h)],l.prototype,"closeStickyCart",null);s([d(w)],l.prototype,"toggleSidebarCart",null);s([d(j)],l.prototype,"clearCart",null);s([_()],l,"cartItems",null);s([_()],l,"cartTotal",null);s([_()],l,"cartHasDigital",null);s([_()],l,"stickyCart",null);s([_()],l,"sidebarCartOpen",null);l=s([I({name:"cart",defaults:{items:[],total:0,is_digital_only:null,stickyCartOpen:!1,sidebarCartOpen:!1}})],l);export{l as a};
