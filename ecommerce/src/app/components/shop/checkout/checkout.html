<app-breadcrumb [breadcrumb]="breadcrumb" />

<section class="section-b-space checkout-section-2">
  <div class="container">
    <div class="checkout-page">
      <div class="checkout-form">
        <form [formGroup]="form">
          <div class="row g-sm-4 g-3">

            <!-- ════════════ LEFT COLUMN ════════════ -->
            <div class="col-lg-7">
              <div class="left-sidebar-checkout">
                <div class="checkout-detail-box">

                  <!-- GUEST flow -->
                  @if((setting$ | async) && !(accessToken$ | async)){
                  <div class="checkout-form-section">

                    <div class="checkout-section-card">
                      <div class="checkout-section-header">
                        <span class="step-badge">1</span>
                        <h3>{{ 'account_details' | translate }}</h3>
                      </div>
                      <div class="row g-sm-3 g-2">
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'name' | translate }}</label>
                            <input type="text" class="form-control" formControlName="name"
                              placeholder="{{ 'enter_name' | translate }}" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'email' | translate }}</label>
                            <input type="email" class="form-control" formControlName="email"
                              placeholder="{{ 'enter_email_address' | translate }}" />
                          </div>
                        </div>
                        <div class="col-12 phone-field">
                          <div class="form-box position-relative">
                            <label class="form-label">{{ 'phone_number' | translate }}</label>
                            @if(isBrowser){
                            <select2 class="custom-select intl-tel-input" [templates]="template"
                              [data]="codes" formControlName="country_code">
                              <ng-template #template let-data="data">
                                <div class="country">
                                  <div class="flag-box"><div class="iti-flag {{data?.class}}"></div></div>
                                  <span class="dial-code">{{data.code}}</span>
                                </div>
                              </ng-template>
                            </select2>
                            }
                            <input type="tel" class="form-control intl-input-padding" formControlName="phone"
                              placeholder="{{ 'enter_phone' | translate }}" />
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="checkout-section-card">
                      <div class="checkout-section-header">
                        <span class="step-badge">2</span>
                        <h3>{{ 'shipping_details' | translate }}</h3>
                      </div>
                      <div class="row g-sm-3 g-2" formGroupName="shipping_address">
                        <div class="col-12">
                          <div class="form-box">
                            <label class="form-label">{{ 'title' | translate }}</label>
                            <input type="text" class="form-control" formControlName="title" placeholder="{{ 'enter_name' | translate }}" />
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-box">
                            <label class="form-label">{{ 'address' | translate }}</label>
                            <input type="text" class="form-control" formControlName="street" placeholder="{{ 'enter_address' | translate }}" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'country' | translate }}</label>
                            <input type="text" class="form-control" formControlName="country_name" placeholder="e.g. Nepal" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'state' | translate }}</label>
                            <input type="text" class="form-control" formControlName="state_name" placeholder="e.g. Bagmati" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'city' | translate }}</label>
                            <input type="text" class="form-control" formControlName="city" placeholder="{{ 'enter_city' | translate }}" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'pincode' | translate }}</label>
                            <input type="text" class="form-control" formControlName="pincode" placeholder="{{ 'enter_pincode' | translate }}" />
                          </div>
                        </div>
                        <div class="col-12 phone-field">
                          <div class="form-box position-relative">
                            <label class="form-label">{{ 'phone_number' | translate }}</label>
                            @if(isBrowser){
                            <select2 class="custom-select intl-tel-input" [templates]="template"
                              [data]="codes" formControlName="country_code">
                              <ng-template #template let-data="data">
                                <div class="country">
                                  <div class="flag-box"><div class="iti-flag {{data?.class}}"></div></div>
                                  <span class="dial-code">{{data?.code}}</span>
                                </div>
                              </ng-template>
                            </select2>
                            }
                            <input type="tel" class="form-control intl-input-padding" formControlName="phone"
                              placeholder="{{ 'enter_phone' | translate }}" />
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="checkout-section-card">
                      <div class="checkout-section-header">
                        <span class="step-badge">3</span>
                        <h3>{{ 'billing_details' | translate }}</h3>
                      </div>
                      @if(form.controls['shipping_address']?.valid){
                      <div class="mb-3" formGroupName="billing_address">
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input" id="same_shipping" formControlName="same_shipping" />
                          <label class="form-check-label" for="same_shipping">{{ 'same_as_shipping' | translate }}</label>
                        </div>
                      </div>
                      }
                      @if(!form.get('billing_address.same_shipping')?.value){
                      <div class="row g-sm-3 g-2" formGroupName="billing_address">
                        <div class="col-12">
                          <div class="form-box">
                            <label class="form-label">{{ 'title' | translate }}</label>
                            <input type="text" class="form-control" formControlName="title" placeholder="{{ 'enter_name' | translate }}" />
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-box">
                            <label class="form-label">{{ 'address' | translate }}</label>
                            <input type="text" class="form-control" formControlName="street" placeholder="{{ 'enter_address' | translate }}" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'country' | translate }}</label>
                            <input type="text" class="form-control" formControlName="country_name" placeholder="e.g. Nepal" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'state' | translate }}</label>
                            <input type="text" class="form-control" formControlName="state_name" placeholder="e.g. Bagmati" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'city' | translate }}</label>
                            <input type="text" class="form-control" formControlName="city" placeholder="{{ 'enter_city' | translate }}" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'pincode' | translate }}</label>
                            <input type="text" class="form-control" formControlName="pincode" placeholder="{{ 'enter_pincode' | translate }}" />
                          </div>
                        </div>
                        <div class="col-12 phone-field">
                          <div class="form-box position-relative">
                            <label class="form-label">{{ 'phone_number' | translate }}</label>
                            @if(isBrowser){
                            <select2 class="custom-select intl-tel-input" [templates]="template"
                              [data]="codes" formControlName="country_code">
                              <ng-template #template let-data="data">
                                <div class="country">
                                  <div class="flag-box"><div class="iti-flag {{data?.class}}"></div></div>
                                  <span class="dial-code">{{data?.code}}</span>
                                </div>
                              </ng-template>
                            </select2>
                            }
                            <input type="tel" class="form-control intl-input-padding" formControlName="phone"
                              placeholder="{{ 'enter_phone' | translate }}" />
                          </div>
                        </div>
                      </div>
                      }
                    </div>

                    <div class="checkout-section-card">
                      <div class="checkout-section-header">
                        <span class="step-badge">4</span>
                        <h3>{{ 'delivery_options' | translate }}</h3>
                      </div>
                      <app-delivery-block [setting]="(setting$ | async)!" (selectDelivery)="selectDelivery($event)" />
                    </div>

                    <div class="checkout-section-card">
                      <div class="checkout-section-header">
                        <span class="step-badge">5</span>
                        <h3>{{ 'payment_options' | translate }}</h3>
                      </div>
                      <app-payment-block [setting]="(setting$ | async)!" (selectPaymentMethod)="selectPaymentMethod($event)" />
                    </div>

                  </div>
                  }

                  <!-- LOGGED-IN flow -->
                  @if(accessToken$ | async){
                  <div class="checkout-form-section">

                    @if(!(cartDigital$ | async)){
                    <div class="checkout-section-card">
                      <div class="checkout-section-header">
                        <span class="step-badge">1</span>
                        <h3>{{ 'shipping_details' | translate }}</h3>
                      </div>

                      <div class="address-radio-list mb-3">
                        @for(addr of (addresses$ | async) ?? []; track addr.id){
                        <label class="address-radio-item" [class.selected]="selectedShippingAddress?.id === addr.id">
                          <input type="radio" name="shipping_addr_radio"
                            [checked]="selectedShippingAddress?.id === addr.id"
                            (change)="selectSavedShippingAddress(addr)" />
                          <div class="address-radio-content">
                            <div class="address-radio-title">{{ addr.title }}</div>
                            <div class="address-radio-detail">
                              {{ addr.street }}, {{ addr.city }}, {{ addr.pincode }}@if(addr.state_name){ · {{ addr.state_name }}}@if(addr.country_name){ · {{ addr.country_name }}}
                            </div>
                            <div class="address-radio-phone">{{ addr.country_code }} {{ addr.phone }}</div>
                          </div>
                        </label>
                        }
                        <button type="button" class="address-radio-add" (click)="openAddressModal('shipping')">
                          <i class="ri-add-circle-line"></i>
                          <span>Add New Address</span>
                        </button>
                      </div>

                      @if(showNewShippingForm || !(addresses$ | async)?.length){
                      <div class="row g-sm-3 g-2" formGroupName="shipping_address">
                        <div class="col-12">
                          <div class="form-box">
                            <label class="form-label">{{ 'title' | translate }}</label>
                            <input type="text" class="form-control" formControlName="title" placeholder="{{ 'enter_name' | translate }}" />
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-box">
                            <label class="form-label">{{ 'address' | translate }}</label>
                            <input type="text" class="form-control" formControlName="street" placeholder="{{ 'enter_address' | translate }}" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'country' | translate }}</label>
                            <input type="text" class="form-control" formControlName="country_name" placeholder="e.g. Nepal" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'state' | translate }}</label>
                            <input type="text" class="form-control" formControlName="state_name" placeholder="e.g. Bagmati" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'city' | translate }}</label>
                            <input type="text" class="form-control" formControlName="city" placeholder="{{ 'enter_city' | translate }}" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'pincode' | translate }}</label>
                            <input type="text" class="form-control" formControlName="pincode" placeholder="{{ 'enter_pincode' | translate }}" />
                          </div>
                        </div>
                        <div class="col-12 phone-field">
                          <div class="form-box position-relative">
                            <label class="form-label">{{ 'phone_number' | translate }}</label>
                            @if(isBrowser){
                            <select2 class="custom-select intl-tel-input" [templates]="template"
                              [data]="codes" formControlName="country_code">
                              <ng-template #template let-data="data">
                                <div class="country">
                                  <div class="flag-box"><div class="iti-flag {{data?.class}}"></div></div>
                                  <span class="dial-code">{{data?.code}}</span>
                                </div>
                              </ng-template>
                            </select2>
                            }
                            <input type="tel" class="form-control intl-input-padding" formControlName="phone"
                              placeholder="{{ 'enter_phone' | translate }}" name="sphone" />
                          </div>
                        </div>
                      </div>
                      <div class="form-check mt-3">
                        <input type="checkbox" class="form-check-input" id="saveShippingAddr"
                          [checked]="saveShippingAddress"
                          (change)="saveShippingAddress = $any($event.target).checked" />
                        <label class="form-check-label" for="saveShippingAddr">Save for future orders</label>
                      </div>
                      }
                    </div>
                    }

                    <div class="checkout-section-card">
                      <div class="checkout-section-header">
                        <span class="step-badge">{{ (cartDigital$ | async) ? '1' : '2' }}</span>
                        <h3>{{ 'billing_details' | translate }}</h3>
                      </div>

                      @if(form.controls['shipping_address']?.valid){
                      <div class="mb-3" formGroupName="billing_address">
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input" id="same_shipping2" formControlName="same_shipping" />
                          <label class="form-check-label" for="same_shipping2">{{ 'same_as_shipping' | translate }}</label>
                        </div>
                      </div>
                      }

                      @if(!form.get('billing_address.same_shipping')?.value){
                      <div class="address-radio-list mb-3">
                        @for(addr of (addresses$ | async) ?? []; track addr.id){
                        <label class="address-radio-item" [class.selected]="selectedBillingAddress?.id === addr.id">
                          <input type="radio" name="billing_addr_radio"
                            [checked]="selectedBillingAddress?.id === addr.id"
                            (change)="selectSavedBillingAddress(addr)" />
                          <div class="address-radio-content">
                            <div class="address-radio-title">{{ addr.title }}</div>
                            <div class="address-radio-detail">
                              {{ addr.street }}, {{ addr.city }}, {{ addr.pincode }}@if(addr.state_name){ · {{ addr.state_name }}}@if(addr.country_name){ · {{ addr.country_name }}}
                            </div>
                            <div class="address-radio-phone">{{ addr.country_code }} {{ addr.phone }}</div>
                          </div>
                        </label>
                        }
                        <button type="button" class="address-radio-add" (click)="openAddressModal('billing')">
                          <i class="ri-add-circle-line"></i>
                          <span>Add New Address</span>
                        </button>
                      </div>

                      @if(showNewBillingForm || !(addresses$ | async)?.length){
                      <div class="row g-sm-3 g-2" formGroupName="billing_address">
                        <div class="col-12">
                          <div class="form-box">
                            <label class="form-label">{{ 'title' | translate }}</label>
                            <input type="text" class="form-control" formControlName="title" placeholder="{{ 'enter_name' | translate }}" />
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="form-box">
                            <label class="form-label">{{ 'address' | translate }}</label>
                            <input type="text" class="form-control" formControlName="street" placeholder="{{ 'enter_address' | translate }}" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'country' | translate }}</label>
                            <input type="text" class="form-control" formControlName="country_name" placeholder="e.g. Nepal" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'state' | translate }}</label>
                            <input type="text" class="form-control" formControlName="state_name" placeholder="e.g. Bagmati" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'city' | translate }}</label>
                            <input type="text" class="form-control" formControlName="city" placeholder="{{ 'enter_city' | translate }}" />
                          </div>
                        </div>
                        <div class="col-sm-6">
                          <div class="form-box">
                            <label class="form-label">{{ 'pincode' | translate }}</label>
                            <input type="text" class="form-control" formControlName="pincode" placeholder="{{ 'enter_pincode' | translate }}" />
                          </div>
                        </div>
                        <div class="col-12 phone-field">
                          <div class="form-box position-relative">
                            <label class="form-label">{{ 'phone_number' | translate }}</label>
                            @if(isBrowser){
                            <select2 class="custom-select intl-tel-input" [templates]="template"
                              [data]="codes" formControlName="country_code">
                              <ng-template #template let-data="data">
                                <div class="country">
                                  <div class="flag-box"><div class="iti-flag {{data?.class}}"></div></div>
                                  <span class="dial-code">{{data?.code}}</span>
                                </div>
                              </ng-template>
                            </select2>
                            }
                            <input type="tel" class="form-control intl-input-padding" formControlName="phone"
                              placeholder="{{ 'enter_phone' | translate }}" name="bphone" />
                          </div>
                        </div>
                      </div>
                      <div class="form-check mt-3">
                        <input type="checkbox" class="form-check-input" id="saveBillingAddr"
                          [checked]="saveBillingAddress"
                          (change)="saveBillingAddress = $any($event.target).checked" />
                        <label class="form-check-label" for="saveBillingAddr">Save for future orders</label>
                      </div>
                      }
                      }
                    </div>

                    @if(!(cartDigital$ | async)){
                    <div class="checkout-section-card">
                      <div class="checkout-section-header">
                        <span class="step-badge">3</span>
                        <h3>{{ 'delivery_options' | translate }}</h3>
                      </div>
                      <app-delivery-block [setting]="(setting$ | async)!" (selectDelivery)="selectDelivery($event)" />
                    </div>
                    }

                    <div class="checkout-section-card">
                      <div class="checkout-section-header">
                        <span class="step-badge">{{ (cartDigital$ | async) ? '2' : '4' }}</span>
                        <h3>{{ 'payment_options' | translate }}</h3>
                      </div>
                      <app-payment-block [setting]="(setting$ | async)!" (selectPaymentMethod)="selectPaymentMethod($event)" />
                    </div>

                  </div>
                  }

                </div>
              </div>
            </div>

            <!-- ════════════ RIGHT COLUMN — ORDER SUMMARY ════════════ -->
            <div class="col-lg-5">
              <div class="checkout-right-box">

                @if((cartItem$ | async)?.length){

                <!-- Item list -->
                <div class="order-summary-card">
                  <div class="order-summary-header">
                    <h4>{{ 'summary_order' | translate }}</h4>
                    <span class="item-count">{{ (cartItem$ | async)?.length }} item(s)</span>
                  </div>
                  <ul class="order-item-list">
                    @for(item of cartItem$ | async; track item.id){
                    <li class="order-item">
                      <div class="order-item-img">
                        <img
                          [src]="item?.variation && item?.variation?.variation_image
                            ? item?.variation?.variation_image?.original_url
                            : item?.product?.product_thumbnail
                            ? item?.product?.product_thumbnail?.original_url
                            : 'assets/images/placeholder/product.png'"
                          class="img-fluid" alt="product" />
                        <span class="order-item-qty">{{ item.quantity }}</span>
                      </div>
                      <div class="order-item-info">
                        <p class="order-item-name">{{ item?.variation ? item?.variation?.name : item?.product?.name }}</p>
                      </div>
                      <div class="order-item-price">
                        {{ (item?.variation ? item.variation.sale_price
                          : item?.wholesale_price ? item?.wholesale_price
                          : item?.product?.sale_price)! * item.quantity | currencySymbol }}
                      </div>
                    </li>
                    }
                  </ul>
                </div>

                <!-- Promo code (logged-in only) -->
                @if(accessToken$ | async){
                <div class="coupon-section">
                  <div class="coupon-section-header">
                    <i class="ri-coupon-3-line"></i>
                    <span>Promo Code</span>
                  </div>

                  @if(appliedCoupon$ | async; as applied){
                  <div class="coupon-applied">
                    <div class="coupon-applied-info">
                      <i class="ri-check-line"></i>
                      <div>
                        <strong>{{ applied.code }}</strong>
                        <span class="coupon-applied-save">Saving {{ applied.discount_amount | currencySymbol }}</span>
                      </div>
                    </div>
                    <button type="button" class="coupon-remove-btn" (click)="removeCoupon()">
                      <i class="ri-close-line"></i>
                    </button>
                  </div>
                  } @else {
                  <div class="coupon-input-row">
                    <input type="text" class="form-control coupon-input"
                      [(ngModel)]="couponInput" [ngModelOptions]="{standalone: true}"
                      placeholder="Enter promo code" (keyup.enter)="applyCoupon()" />
                    <app-button [class]="'btn btn-solid coupon-apply-btn'" [spinner]="applyingCoupon"
                      [id]="'apply_coupon_btn'" (click)="applyCoupon()">Apply</app-button>
                  </div>
                  @if(couponError$ | async; as err){
                  <div class="coupon-error">
                    <i class="ri-error-warning-line"></i> {{ err }}
                  </div>
                  }
                  }
                </div>
                }

                <!-- Price breakdown -->
                <div class="price-breakdown">
                  @let cartItems = (cartItem$ | async) ?? [];
                  @let applied = (appliedCoupon$ | async);
                  <div class="price-row">
                    <span>Subtotal</span>
                    <span>{{ getCartSubTotal(cartItems) | currencySymbol }}</span>
                  </div>
                  @if(applied){
                  <div class="price-row discount-row">
                    <span><i class="ri-coupon-line"></i> {{ applied.code }}</span>
                    <span class="discount-amount">−{{ applied.discount_amount | currencySymbol }}</span>
                  </div>
                  }
                  <div class="price-row">
                    <span>Shipping</span>
                    <span class="free-label">Free</span>
                  </div>
                  <div class="price-divider"></div>
                  <div class="price-row total-row">
                    <span>Total</span>
                    <span class="total-amount">{{ getOrderTotal(cartItems, applied) | currencySymbol }}</span>
                  </div>
                </div>

                <!-- Place Order button -->
                <app-button
                  [class]="'btn btn-solid place-order-btn w-100'"
                  [id]="'place_order_btn'"
                  [spinner]="loading"
                  [disabled]="!form.valid"
                  (click)="placeorder()"
                >
                  <i class="ri-lock-line me-2"></i>
                  {{ 'place_order' | translate }}
                </app-button>

                <div class="checkout-security-note">
                  <i class="ri-secure-payment-line"></i>
                  <span>Secure &amp; Encrypted Checkout</span>
                </div>

                } @else {
                <app-no-data
                  [class]="'no-data-added'"
                  [image]="'assets/svg/empty-items.svg'"
                  [text]="'no_cart_item_desc' | translate"
                />
                }
              </div>
            </div>

          </div>
        </form>
      </div>
    </div>
  </div>
</section>
